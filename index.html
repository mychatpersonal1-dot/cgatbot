<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Pro Fixed</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root { --wa-teal:#075E54; --wa-green:#25D366; --wa-bg:#efe7de;}
*{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
body{background:#dadbd3;height:100vh;overflow:hidden}
.hidden{display:none}
header{background:var(--wa-teal);color:white;padding:12px 15px;display:flex;justify-content:space-between;align-items:center}
#chat-window{position:fixed;inset:0;background:var(--wa-bg);z-index:2000;display:flex;flex-direction:column;transform:translateX(100%);transition:.3s}
#chat-window.open{transform:translateX(0)}
.msg-area{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column}
.msg{padding:8px 12px;border-radius:8px;margin-bottom:5px;max-width:80%}
.sent{align-self:flex-end;background:#dcf8c6}
.received{align-self:flex-start;background:white}
.user-item{display:flex;align-items:center;padding:15px;background:white;border-bottom:1px solid #eee;cursor:pointer}
.user-item img{width:45px;height:45px;border-radius:50%;margin-right:15px}
</style>
</head>

<body>

<div id="login-screen" style="position:fixed;inset:0;background:var(--wa-teal);display:flex;align-items:center;justify-content:center;">
<div style="background:white;padding:30px;border-radius:10px;width:90%;max-width:350px;">
<h2 style="text-align:center;color:var(--wa-teal);margin-bottom:20px;">WhatsApp Pro</h2>
<input type="email" id="l-email" placeholder="Email" style="width:100%;padding:12px;margin-bottom:10px;">
<input type="password" id="l-pass" placeholder="Password" style="width:100%;padding:12px;margin-bottom:10px;">
<button onclick="doLogin()" style="width:100%;padding:12px;background:var(--wa-green);color:white;border:none;">LOGIN</button>
</div>
</div>

<div id="main-app" class="hidden">
<header>
<b>WhatsApp</b>
<i class="fas fa-sign-out-alt" onclick="logout()" style="cursor:pointer;"></i>
</header>
<div id="user-list"></div>
</div>

<div id="chat-window">
<div style="background:var(--wa-teal);color:white;padding:10px;display:flex;align-items:center;">
<i class="fas fa-arrow-left" onclick="closeChat()" style="padding:10px;cursor:pointer;"></i>
<b id="chat-name" style="flex:1;margin-left:10px;"></b>
<i class="fas fa-phone" onclick="startCall('audio')" style="margin-right:20px;cursor:pointer;"></i>
<i class="fas fa-video" onclick="startCall('video')" style="cursor:pointer;"></i>
</div>
<div id="msg-area" class="msg-area"></div>
<div style="padding:10px;background:#f0f0f0;display:flex;">
<input type="text" id="m-input" placeholder="Type message..." style="flex:1;padding:10px;">
<i class="fas fa-paper-plane" onclick="sendMsg()" style="color:var(--wa-teal);font-size:22px;margin-left:10px;cursor:pointer;"></i>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, setDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyDIDlnsjU80luMXAO_JsRJQTMHPhEVpbQs",
authDomain:"my-chat-project-4e376.firebaseapp.com",
projectId:"my-chat-project-4e376",
appId:"1:264696350288:web:8c0367e6dce7c5f5517355"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let me=null,peer=null;
let pc=null;
const servers={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

window.doLogin=async()=>{
const email=document.getElementById("l-email").value;
const pass=document.getElementById("l-pass").value;
try{
await signInWithEmailAndPassword(auth,email,pass);
}catch{
await createUserWithEmailAndPassword(auth,email,pass);
await setDoc(doc(db,"users",email),{email});
}
};

onAuthStateChanged(auth,user=>{
if(user){
me=user;
document.getElementById("login-screen").classList.add("hidden");
document.getElementById("main-app").classList.remove("hidden");
loadUsers();
listenIncoming();
}
});

function loadUsers(){
onSnapshot(collection(db,"users"),snap=>{
const list=document.getElementById("user-list");
list.innerHTML="";
snap.forEach(d=>{
if(d.id!==me.email){
const div=document.createElement("div");
div.className="user-item";
div.innerHTML=`<img src="https://ui-avatars.com/api/?name=${d.id}"><b>${d.id}</b>`;
div.onclick=()=>openChat(d.id);
list.appendChild(div);
}
});
});
}

function openChat(email){
peer=email;
document.getElementById("chat-name").innerText=email;
document.getElementById("chat-window").classList.add("open");
listenMessages();
}

function closeChat(){
document.getElementById("chat-window").classList.remove("open");
}

function listenMessages(){
const cid=me.email<peer?me.email+"_"+peer:peer+"_"+me.email;
const q=query(collection(db,"messages"),where("cid","==",cid),orderBy("time"));
onSnapshot(q,snap=>{
const area=document.getElementById("msg-area");
area.innerHTML="";
snap.forEach(d=>{
const m=d.data();
const div=document.createElement("div");
div.className="msg "+(m.sender===me.email?"sent":"received");
div.innerText=m.text;
area.appendChild(div);
});
});
}

window.sendMsg=async()=>{
const val=document.getElementById("m-input").value;
const cid=me.email<peer?me.email+"_"+peer:peer+"_"+me.email;
await addDoc(collection(db,"messages"),{
cid,sender:me.email,text:val,time:Date.now()
});
document.getElementById("m-input").value="";
};

window.startCall=async(mode)=>{
if(!peer)return alert("Select user first");
const callId=me.email<peer?me.email+"_"+peer:peer+"_"+me.email;

pc=new RTCPeerConnection(servers);

const stream=await navigator.mediaDevices.getUserMedia({video:mode==="video",audio:true});
stream.getTracks().forEach(track=>pc.addTrack(track,stream));

pc.onicecandidate=e=>{
if(e.candidate){
addDoc(collection(db,"candidates"),{callId,candidate:e.candidate.toJSON()});
}
};

const offer=await pc.createOffer();
await pc.setLocalDescription(offer);

await setDoc(doc(db,"calls",callId),{offer,caller:me.email,receiver:peer,mode});

onSnapshot(doc(db,"calls",callId),async snap=>{
const data=snap.data();
if(data?.answer&&!pc.currentRemoteDescription){
await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
}
});

const cq=query(collection(db,"candidates"),where("callId","==",callId));
onSnapshot(cq,snap=>{
snap.docChanges().forEach(change=>{
if(change.type==="added"){
pc.addIceCandidate(new RTCIceCandidate(change.doc.data().candidate));
}
});
});
};

function listenIncoming(){
const q=query(collection(db,"calls"),where("receiver","==",me.email));
onSnapshot(q,snap=>{
snap.docChanges().forEach(async change=>{
if(change.type==="added"){
const data=change.doc.data();
if(confirm("Incoming call from "+data.caller)){
const callId=change.doc.id;
pc=new RTCPeerConnection(servers);
const stream=await navigator.mediaDevices.getUserMedia({video:data.mode==="video",audio:true});
stream.getTracks().forEach(track=>pc.addTrack(track,stream));
await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
const answer=await pc.createAnswer();
await pc.setLocalDescription(answer);
await updateDoc(doc(db,"calls",callId),{answer});
}
}
});
});
}

window.logout=()=>{signOut(auth).then(()=>location.reload())};
</script>
</body>
</html>
