<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBook Chat Fix</title>
    <script src="https://unpkg.com/zego-zim-web@2.12.0/index.js"></script>
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        #main-app { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .user-item:hover { background: #f9f9f9; }
        .user-item img { width: 40px; border-radius: 50%; margin-right: 10px; }
        .call-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-audio { background: #25d366; }
        .btn-video { background: #075e54; }
        .btn-logout { background: #ff4757; margin-top: 10px; width: 100%; }
        #login-screen { max-width: 300px; margin: 100px auto; text-align: center; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>StudyBook Login</h2>
        <input type="email" id="l-email" placeholder="Email (admin@gmail.com)">
        <input type="password" id="l-pass" placeholder="Password">
        <button onclick="doLogin()" style="background: #007bff; width: 100%;">Login / Sign Up</button>
    </div>

    <div id="main-app" class="hidden">
        <h3>Welcome, <span id="my-name"></span></h3>
        
        <div id="user-list">
            <p style="color: gray;">Loading users...</p>
        </div>

        <hr>
        <div class="call-buttons">
            <button class="btn-audio" onclick="makeCall('audio')">ðŸ“ž Voice Call</button>
            <button class="btn-video" onclick="makeCall('video')">ðŸ“¹ Video Call</button>
        </div>

        <button class="btn-logout" onclick="logout()">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDIDlnsjU80luMXAO_JsRJQTMHPhEVpbQs", 
            authDomain: "my-chat-project-4e376.firebaseapp.com", 
            projectId: "my-chat-project-4e376", 
            appId: "1:264696350288:web:8c0367e6dce7c5f5517355"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let me = null;
        let zp = null;

        // --- ZEGO INIT ---
        async function initZego(userId) {
            if (!window.ZegoUIKitPrebuilt || !window.ZIM) {
                setTimeout(() => initZego(userId), 1000);
                return;
            }
            try {
                const appID = 1452296766; 
                const serverSecret = "66f773957cc433e5456f9185a1a1f0f5";
                const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, userId, userId, userId);
                zp = ZegoUIKitPrebuilt.create(kitToken);
                zp.addPlugins({ ZIM: window.ZIM }); 
                console.log("ZEGO READY âœ…");
            } catch (err) { console.error(err); }
        }

        // --- FIXED CALL LOGIC ---
        window.makeCall = (type) => {
            if (!zp) return alert("Zego is loading... wait 5s");
            
            // Fixed logic for your emails
            let targetEmail = "";
            if (me.email === "admin@gmail.com") targetEmail = "bookb@gmail.com";
            else if (me.email === "bookb@gmail.com") targetEmail = "admin@gmail.com";
            else return alert("Sirf Admin aur BookB call kar sakte hain!");

            zp.sendCallInvitation({
                invitees: [{ userID: targetEmail, userName: targetEmail }],
                isVideoCall: type === 'video',
                timeout: 60,
            }).then(res => {
                if (res.errorInvitees?.length > 0) alert("User offline hai!");
            }).catch(err => alert("Error: " + err.message));
        };

        // --- AUTH & USER LIST ---
        window.doLogin = async () => {
            const e = document.getElementById('l-email').value.trim();
            const p = document.getElementById('l-pass').value.trim();
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch {
                await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", e), { email: e });
            }
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                me = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('my-name').innerText = me.email;
                initZego(me.email);
                loadList();
            }
        });

        function loadList() {
            onSnapshot(collection(db, "users"), snap => {
                const list = document.getElementById('user-list'); list.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    if(u.email !== me.email) {
                        const div = document.createElement('div'); div.className = "user-item";
                        div.innerHTML = `<img src="https://ui-avatars.com/api/?name=${u.email}"> <b>${u.email}</b>`;
                        list.appendChild(div);
                    }
                });
            });
        }

        window.logout = () => signOut(auth).then(()=>location.reload());
    </script>
</body>
</html>
